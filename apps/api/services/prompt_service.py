import logging
from typing import List, Dict, Any
from packages.core_domain import Generation

logger = logging.getLogger(__name__)

class PromptService:
    @staticmethod
    def construct_classifier_prompt(input_text: str) -> str:
        """Промпт для классификации запроса (задача vs болтовня)."""
        prompt = f"""
        Ты — системный фильтр сервиса "Зачёт". Твоя задача — определить, является ли текст ниже условием конкретной академической задачи (математика, физика, химия, программирование и т.д.).
        
        ТЕКСТ ПОЛЬЗОВАТЕЛЯ:
        ---
        {input_text}
        ---
        
        ПРАВИЛА КЛАССИФИКАЦИИ:
        1. Если текст содержит условие задачи, вопрос по конкретному примеру или данные для расчета — это "task".
        2. Если текст является общим вопросом ("расскажи про ИИ", "как выучить питон"), просьбой написать эссе без темы, или просто приветствием — это "chat".
        3. Если в тексте только общие слова типа "помоги", "объясни" без контекста — это "chat".
        
        Верни результат в формате JSON: {{"type": "task" | "chat", "reason": "краткое пояснение"}}
        """
        return prompt.strip()

    @staticmethod
    def construct_structure_prompt(generation: Generation) -> str:
        """Промпт для генерации структуры плана."""
        complexity_guide = {
            "school": "простым языком, доступным для школьников, без сложной терминологии",
            "student": "академическим языком, соответствующим вузовским требованиям, с анализом теорий",
            "research": "высокоуровневым научным языком, с фокусом на методологию и критический анализ"
        }
        
        style = complexity_guide.get(generation.complexity_level, complexity_guide["student"])
        
        prompt = f"""
        Ты — экспертный академический методист. Сформулируй подробный план для работы типа {generation.work_type}.
        Тема: {generation.input_payload.get('topic')}
        Цель: {generation.input_payload.get('goal')}
        Основная идея: {generation.input_payload.get('idea')}
        Объем: {generation.input_payload.get('volume')} страниц.
        
        ИНСТРУКЦИЯ ПО ФОРМАТУ:
        - Тон изложения: {style}.
        - План должен включать: Введение, Основную часть (главы/параграфы), Заключение, Литература.
        - НИКАКИХ приветствий и лишних рассуждений. Только структура.
        
        Верни результат в формате JSON: {{"structure": [{{"title": "...", "level": 1}}]}}
        """
        return prompt.strip()

    @staticmethod
    def construct_sources_prompt(generation: Generation) -> str:
        """Промпт для подбора источников литературы."""
        prompt = f"""
        Ты — библиограф в крупной научной библиотеке. Подбери список актуальных источников для следующей работы:
        Тип: {generation.work_type}
        Тема: {generation.input_payload.get('topic')}
        
        ТРЕБОВАНИЯ:
        1. Минимум 5-7 источников.
        2. Источники должны быть реальными (научные статьи, книги, учебники).
        3. Оформи по стандарту ГОСТ Р 7.0.100–2018.
        4. Для каждого источника напиши краткое описание (1-2 предложения), почему он важен для этой темы.
        
        Верни результат в формате JSON: {{"sources": [{{"title": "...", "url": "...", "description": "..."}}]}}
        """
        return prompt.strip()

    @staticmethod
    def construct_generation_prompt(generation: Generation, section_title: str, previous_context: str = "") -> str:
        """Промпт для генерации текста конкретного раздела."""
        prompt = f"""
        Напиши текст для раздела "{section_title}" в рамках работы на тему "{generation.input_payload.get('topic')}".
        
        КОНТЕКСТ:
        Цель: {generation.input_payload.get('goal')}
        Идея: {generation.input_payload.get('idea')}
        
        ТРЕБОВАНИЯ К ТЕКСТУ:
        - СТРОГО академический стиль.
        - НИКАКОЙ "воды", вводных фраз типа "в данной работе мы рассмотрим" (если это не введение).
        - Только факты, анализ и логические выводы.
        - Максимальная плотность информации.
        - Если есть формулы — используй LaTeX.
        
        {f"ПРЕДЫДУЩЕЕ СОДЕРЖАНИЕ: {previous_context}" if previous_context else ""}
        """
        return prompt.strip()

    @staticmethod
    def construct_humanize_prompt(text: str, humanity_level: int) -> str:
        """Промпт для финального очеловечивания текста (Claude 3.5 Sonnet style)."""
        if humanity_level < 20:
            return text # Почти не меняем
            
        instructions = ""
        if humanity_level > 70:
            instructions = """
            - Максимально разнообразь синтаксис: смешивай очень длинные и очень короткие предложения.
            - Используй вводные слова, характерные для живой академической речи (например, 'собственно', 'между тем', 'как нам кажется').
            - Удали типичные ИИ-маркеры: 'Важно отметить', 'В заключение стоит сказать', 'Это играет ключевую роль'.
            - Добавь легкие стилистические неровности, чтобы текст не выглядел 'вылизанным' нейросетью.
            """
        else:
            instructions = """
            - Сделай текст более естественным, убери монотонность.
            - Используй синонимы, чтобы избежать повторов.
            - Соблюдай правила русского языка, но избегай канцелярщины.
            """

        prompt = f"""
        Перепиши следующий академический текст, чтобы он выглядел так, будто его написал человек, а не ИИ.
        
        ТЕКСТ ДЛЯ ОБРАБОТКИ:
        ---
        {text}
        ---
        
        ИНСТРУКЦИИ:
        {instructions}
        
        ВАЖНО: Сохрани все факты, цифры и научную суть. Изменяй ТОЛЬКО стиль и структуру предложений.
        """
        return prompt.strip()

    @staticmethod
    def construct_qc_prompt(text: str) -> str:
        """Промпт для слоя контроля качества (Quality Control)."""
        prompt = f"""
        Ты — строгий академический корректор. Проверь текст на соответствие стандартам ГОСТ и научному стилю.
        
        ТЕКСТ ДЛЯ ПРОВЕРКИ:
        ---
        {text}
        ---
        
        ЗАДАЧИ:
        1. Проверь отсутствие местоимений "я", "мой" (замени на "мы", "наш" или безличные формы).
        2. Убери точки в конце заголовков.
        3. Исправь стилистические ошибки и канцеляризмы.
        4. Проверь логичность переходов между абзацами.
        5. Удали любые фразы-клише ИИ (например, "в данной главе мы рассмотрели", "важно отметить, что").
        
        Верни ПОЛНОСТЬЮ исправленный текст. Никаких комментариев от себя, только текст работы.
        """
        return prompt.strip()

prompt_service = PromptService()




