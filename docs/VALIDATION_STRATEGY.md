# Стратегия валидации контента

## Философия

Наша система защищена от абьюза **архитектурой интерфейса и биллингом**, а не агрессивной валидацией контента.

## Уровни защиты

### 1. **Архитектурная защита** (основная)
- Многошаговый процесс создания (5 шагов для текстовых работ)
- Каждый шаг требует взаимодействия и времени
- Естественный барьер против автоматизированного спама

### 2. **Биллинг** (экономическая защита)
- Пользователи ограничены кредитами
- Каждая генерация расходует лимит
- Нет экономического смысла тратить кредиты на "привет" или "как дела?"

### 3. **Минимальная валидация** (последняя линия)
- Только базовые проверки (длина, формат)
- Без семантического анализа для текстовых работ
- Семантическая валидация только для задач (1-click flow)

## Правила валидации по типам

### Текстовые работы (TEXT/PRESENTATION)

**Worker:** `TextStructureWorker`

**Валидация:**
```python
# Только проверка минимальной длины
if len(topic.strip()) < 5:
    return error("Пожалуйста, введите тему работы")
```

**Почему НЕТ классификатора:**
- ✅ Пользователь проходит 5 шагов (Тема → Детали → Структура → Источники → Генерация)
- ✅ Если создана структура и источники - тема валидна
- ✅ Классификатор даёт false positives (отклоняет валидные темы)
- ✅ Экономия токенов (~300 токенов на каждую генерацию)
- ✅ Быстрее генерация (на 1 API вызов меньше)

**Пользователь может генерировать работу на ЛЮБУЮ тему.**

### Решение задач (TASK)

**Worker:** `TaskWorker`

**Валидация:**
```python
# 1. Проверка длины
if len(topic.strip()) < 10:
    return error("Слишком короткое условие")

# 2. Семантическая классификация
classification = classify(topic)
if classification.get("type") == "chat":
    return error("Я решаю конкретные учебные задачи")
```

**Почему ЕСТЬ классификатор:**
- ⚠️ Решение в 1 клик (нет промежуточных шагов)
- ⚠️ Выше риск использования как "доступ к ChatGPT"
- ✅ Классификатор точнее определяет задачи vs чат
- ✅ Легче отличить "реши уравнение" от "привет"

## Примеры валидации

### ✅ Проходят валидацию (текстовые работы)

- "влияние ии зумеров в 21 веке"
- "экономика"
- "история Второй мировой войны"
- "квантовая физика и её применение"
- "анализ романа Война и мир"
- "бизнес-план кофейни"
- Любая тема длиннее 5 символов

### ✅ Проходят валидацию (задачи)

- "реши уравнение x^2 + 5x + 6 = 0"
- "напиши код для сортировки массива"
- "рассчитай налог для ИП с доходом 1 млн"
- "найди производную функции sin(x) * cos(x)"

### ❌ НЕ проходят валидацию (задачи)

- "привет" → chat
- "как дела?" → chat
- "что ты умеешь?" → chat
- "спасибо" → chat

### ❌ НЕ проходят валидацию (все типы)

- "" → пустая строка
- "abc" → слишком короткая (< 5 символов)

## История изменений

### 2026-01-15: Удалён классификатор из текстовых работ
- **Проблема:** Классификатор отклонял валидные темы ("влияние ии зумеров в 21 веке" → "chat")
- **Решение:** Убрали семантическую валидацию, оставили только проверку длины
- **Результат:** Нет false positives, экономия токенов, лучший UX

### 2026-01-15: Исправлен QC промпт
- **Проблема:** Отсутствовал `{text}` плейсхолдер, QC получал пустой промпт
- **Решение:** Добавлен `{text}` в промпт QC
- **Результат:** Генерированный текст корректно проходит финальную проверку

## Мониторинг и метрики

### Что отслеживать:

1. **False rejections** - валидные темы, отклонённые валидацией
2. **Abuse attempts** - попытки использовать систему не по назначению
3. **Token usage** - расход токенов на валидацию
4. **User complaints** - жалобы на отклонённые генерации

### Когда пересматривать стратегию:

- ⚠️ Рост abuse attempts > 5% от всех запросов
- ⚠️ Жалобы пользователей на отклонённые валидные темы
- ⚠️ Значительный рост расходов на токены

## Альтернативные подходы (если понадобится)

### Rate Limiting (рекомендуется вместо валидации контента)
```python
# Ограничение частоты запросов
if user.generations_last_hour >= 10:
    raise HTTPException(429, "Too many requests. Please try again later.")
```

### Поведенческий анализ
- Отслеживать паттерны использования
- Блокировать аномальное поведение (слишком частые запросы)
- Не блокировать на основе контента

### Модерация постфактум
- Генерировать всё, что запрашивает пользователь
- Проверять результаты постфактум
- Блокировать аккаунты при систематическом абьюзе

## Выводы

1. **Валидация контента - последняя линия защиты**, не первая
2. **Архитектура и биллинг** защищают лучше, чем семантический анализ
3. **False positives** вредят UX больше, чем редкие случаи абьюза
4. **Для текстовых работ** - минимальная валидация (только длина)
5. **Для задач** - семантическая валидация (высокий риск абьюза)
